{% extends 'store/base.html' %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
    <div style="margin-bottom: 20px;">
        <a href="{% url 'store:products_browse' %}" style="color: #667eea; text-decoration: none;">
            Back to Products
        </a>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
        <!-- Product Image Placeholder -->
        <div style="background: #f5f5f5; height: 400px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 120px;">
            
        </div>
        
        <!-- Product Info -->
        <div>
            <h2 style="color: #333; margin-bottom: 10px;">{{ product.name }}</h2>
            
            <div style="font-size: 14px; color: #999; margin-bottom: 20px;">
                Store: <a href="#" style="color: #667eea; text-decoration: none;"><strong>{{ product.store.name }}</strong></a>
            </div>
            
            <div style="font-size: 36px; font-weight: bold; color: #28a745; margin-bottom: 20px;">
                R{{ product.price }}
            </div>
            
            <div style="margin-bottom: 20px;">
                <span style="font-size: 14px; color: #666;">Stock: </span>
                <span style="font-size: 18px; font-weight: 600; {% if product.stock < 10 %}color: #dc3545;{% else %}color: #667eea;{% endif %}">
                    {{ product.stock }} units available
                </span>
            </div>
            
            <h3 style="color: #333; margin-bottom: 10px;">Description</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 30px;">
                {{ product.description }}
            </p>
            
            {% if request.user.is_authenticated and request.user.groups.all.0.name == 'Buyers' and product.stock > 0 %}
                <form method="POST" action="{% url 'store:cart_add' product_pk=product.pk %}" style="display: flex; gap: 10px; align-items: center;">
                    {% csrf_token %}
                    <label for="quantity" style="font-weight: 500;">Quantity:</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ product.stock }}"
                           style="width: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <button type="submit" class="btn" style="background: #28a745;">
                        Add to Cart
                    </button>
                </form>
            {% elif product.stock == 0 %}
                <button class="btn" disabled style="background: #ccc; cursor: not-allowed;">
                    Out of Stock
                </button>
            {% elif not request.user.is_authenticated %}
                <a href="{% url 'store:login' %}" class="btn">Login to Purchase</a>
            {% endif %}
        </div>
    </div>
    
    <!-- Reviews Section -->
    <div style="border-top: 2px solid #ddd; padding-top: 40px;">
    <h3 style="color: #333; margin-bottom: 20px;">Customer Reviews</h3>

    <!-- Show review form to ALL logged-in buyers -->
    {% if request.user.is_authenticated %}
        {% if request.user.groups.all.0.name == 'Buyers' %}

            <!-- Check if already reviewed -->
            {% if already_reviewed %}
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #28a745;">
                    <p style="margin: 0; color: #155724;">
                        You have already reviewed this product.
                    </p>
                </div>
            {% else %}
                <!-- Review form - available to ALL buyers -->
                <div style="background: #f0f4ff; padding: 20px; border-radius: 8px; margin-bottom: 30px;">

                    {% if can_review %}
                        <!-- Verified review notice -->
                        <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                            <p style="margin: 0; color: #155724; font-size: 14px;">
                                <strong>Verified Purchase!</strong>
                                Your review will show a verified badge.
                            </p>
                        </div>
                    {% else %}
                        <!-- Unverified review notice -->
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                <strong>Unverified Review.</strong>
                                You haven't purchased this product yet.
                                Your review will be marked as unverified.
                                Purchase the product to get a verified badge!
                            </p>
                        </div>
                    {% endif %}

                    <h4 style="margin-bottom: 15px;">Leave a Review</h4>
                    <form method="POST" action="{% url 'store:review_add' product_pk=product.pk %}">
                        {% csrf_token %}
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                Rating:
                            </label>
                            <select name="rating" required style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value="">Select rating...</option>
                                <option value="5">Excellent (5 stars)</option>
                                <option value="4">Good (4 stars)</option>
                                <option value="3">Average (3 stars)</option>
                                <option value="2">Poor (2 stars)</option>
                                <option value="1">Terrible (1 star)</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                Your Review:
                            </label>
                            <textarea name="content" required rows="4"
                                placeholder="Share your experience with this product..."
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        <button type="submit" class="btn">
                            {% if can_review %}
                                Submit Verified Review
                            {% else %}
                                Submit Unverified Review
                            {% endif %}
                        </button>
                    </form>
                </div>
            {% endif %}

        {% endif %}
    {% else %}
        <!-- Not logged in -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center;">
            <p style="color: #666; margin-bottom: 10px;">
                Login to leave a review
            </p>
            <a href="{% url 'store:login' %}" class="btn">Login to Review</a>
        </div>
    {% endif %}

    <!-- Display existing reviews -->
    {% if reviews %}
        <div style="display: grid; gap: 15px;">
            {% for review in reviews %}
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong>{{ review.buyer.username }}</strong>

                            <!-- Show verified or unverified badge -->
                            {% if review.verified %}
                                <span style="background: #28a745; color: white; font-size: 11px; padding: 2px 8px; border-radius: 3px; margin-left: 8px;">
                                    ✓ Verified Purchase
                                </span>
                            {% else %}
                                <span style="background: #ffc107; color: #333; font-size: 11px; padding: 2px 8px; border-radius: 3px; margin-left: 8px;">
                                    Unverified Review
                                </span>
                            {% endif %}
                        </div>

                        <div style="color: #ffc107; font-size: 18px;">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}⭐{% endif %}
                            {% endfor %}
                            <span style="font-size: 14px; color: #666;">({{ review.rating }}/5)</span>
                        </div>
                    </div>

                    <p style="color: #666; line-height: 1.6; margin-bottom: 10px;">
                        {{ review.content }}
                    </p>

                    <div style="font-size: 12px; color: #999;">
                        {{ review.created_at|date:"M d, Y" }}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">
            No reviews yet. Be the first to review this product!
        </p>
    {% endif %}
</div>
{% endblock %}